var Notimoo=new Class({elements:[],Implements:[Options,Events],scrollTimeOut:null,options:{parent:"",height:50,width:300,visibleTime:5e3,locationVType:"top",locationHType:"right",locationVBase:10,locationHBase:10,notificationsMargin:5,opacityTransitionTime:750,closeRelocationTransitionTime:750,scrollRelocationTransitionTime:500,notificationOpacity:.95},initialize:function(options){this.options.parent=document.body;if(options){if(options.parent)this.options.parent=$(options.parent);this.setOptions(options)}var manager=this;if(this.options.parent)this.options.parent.addEvent("scroll",function(){clearTimeout(this.scrollTimeOut);this.scrollTimeOut=function(){manager._relocateActiveNotifications(manager.TYPE_RELOCATE_SCROLL)}.delay(200)},this);window.addEvent("scroll",function(){clearTimeout(manager.scrollTimeOut);manager.scrollTimeOut=function(){manager._relocateActiveNotifications(manager.TYPE_RELOCATE_SCROLL)}.delay(200)});this.elements.push(this.createNotificationElement(this.options))},createNotificationElement:function(){var el=new Element("div",{"class":"notimoo"});el.setStyle(this.options.locationVType,this.options.locationVBase);el.setStyle(this.options.locationHType,this.options.locationHBase);el.adopt(new Element("span",{"class":"title"}));el.adopt(new Element("div",{"class":"message"}));el.setStyle("width",this.options.width);el.setStyle("height",this.options.height);el.store("working",false);el.set("tween",{link:"chain",duration:this.options.opacityTransitionTime});el.set("opacity",0);var fx1=new Fx.Tween(el,{property:this.options.locationVType,link:"chain",duration:this.options.closeRelocationTransitionTime});el.store("baseTween",fx1);var fx2=new Fx.Tween(el,{property:this.options.locationVType,link:"chain",duration:this.options.scrollRelocationTransitionTime});el.store("scrollTween",fx2);el.addEvent("click",function(event){event.stop();this.close(el)}.bind(this));return el},show:function(options){var manager=this;var nextBase=this._applyScrollPosition(this.options.locationVBase);var el=this.elements.filter(function(el){var w=el.retrieve("working");if(w){nextBase=el.getStyle(this.options.locationVType).toInt()+el.getSize().y+this.options.notificationsMargin}return!w},this).getLast();if(!el){el=this.createNotificationElement();this.elements.push(el)}el.setStyle(this.options.locationVType,nextBase);el.store("working",true);if(options.width)el.setStyle("width",options.width);if(options.title){el.getElement("span.title").set("html",options.title)}el.getElement("div.message").set("html",options.message);if(options.customClasses)el.addClass(options.customClasses);el.getElements("a").addEvent("click",function(event){event.stopPropagation()});if(this.options.parent)this.options.parent.adopt(el);this._checkSize(el);el.get("tween").start("opacity",this.options.notificationOpacity).chain(function(){if(options.sticky?!options.sticky:true){(function(){manager.close(el)}).delay(options.visibleTime?options.visibleTime:manager.options.visibleTime,manager)}manager.fireEvent("show",el)})},close:function(element){var manager=this;var nots=manager.elements;element.get("tween").start("opacity",0).chain(function(){if(nots.length>1){nots.elements=nots.erase(element);element.destroy()}manager._resetNotificationElement(element);manager._relocateActiveNotifications(manager.TYPE_RELOCATE_CLOSE);manager.fireEvent("close",element)})},_relocateActiveNotifications:function(sourceEvent){var base=this._applyScrollPosition(this.options.locationVBase);for(var index=0;index<this.elements.length;index++){var el=this.elements[index];if(el.retrieve("working")){if(this.TYPE_RELOCATE_CLOSE==sourceEvent){el.retrieve("baseTween").start(base)}else{el.retrieve("scrollTween").start(base)}base+=el.getSize().y+this.options.notificationsMargin}}},_checkSize:function(element){var notificationElHeight=element.getStyle("height").toInt();var titleHeight=element.getElement("span.title").getSize().y;var messageHeight=element.getElement("div.message").getSize().y;if(messageHeight>notificationElHeight-titleHeight){element.setStyle("height",notificationElHeight+(messageHeight-(notificationElHeight-titleHeight)))}},_resetNotificationElement:function(element){element.store("working",false);element.setStyle(this.options.locationVType,this.options.locationVBase);element.setStyle("height",this.options.height);element.setStyle("width",this.options.width)},_applyScrollPosition:function(base){if(this.options.parent){if(this.options.locationVType=="top")base+=this.options.parent.getScroll().y;else base-=this.options.parent.getScroll().y}return base},TYPE_RELOCATE_CLOSE:1,TYPE_RELOCATE_SCROLL:2});var _notimooNotice;function Notice(text){if(!_notimooNotice)_notimooNotice=new Notimoo;_notimooNotice.show({title:"Notice",customClasses:"notice",message:text})}var _notimooWarning;function Warning(text){if(!_notimooWarning)_notimooWarning=new Notimoo;_notimooWarning.show({title:"Warning",customClasses:"warning",message:text})}var _notimooError;function Error(text){if(!_notimooError)_notimooError=new Notimoo;_notimooError.show({title:"Error",customClasses:"error",message:text})}